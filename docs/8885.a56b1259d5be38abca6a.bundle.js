"use strict";(self.webpackChunkKuiClientTemplate=self.webpackChunkKuiClientTemplate||[]).push([[8885,3129],{48885:(e,t,i)=>{i.r(t),i.d(t,{doExec:()=>P});var n=i(11227),s=i.n(n),o=i(72045),r=i(12320),a=i(18495);var l=i(84932),c=i(3129),d=i(96690),u=i(62549),h=i(16426);function f(e,t,i){for(;e.length<i;)e=t+e;return e}function p(e){const{classList:t,style:i,textContent:n}=function(e){const t=[],i={};let n;e.isBold()&&t.push("xterm-bold"),e.isItalic()&&t.push("xterm-italic"),e.isDim()&&t.push("xterm-dim"),e.isUnderline()&&t.push("xterm-underline"),n=e.isInvisible()?" ":e.getChars()||" ";let s=e.getFgColor(),o=e.getFgColorMode(),r=e.getBgColor(),a=e.getBgColorMode();const l=!!e.isInverse();if(l){const e=s;s=r,r=e;const t=o;o=a,a=t}switch(o){case 16777216:case 33554432:t.push(`xterm-fg-${s}`);break;case 50331648:i.color=`#${f(s.toString(16),"0",6)}`;break;default:l&&t.push("xterm-fg-257")}switch(a){case 16777216:case 33554432:t.push(`xterm-bg-${r}`);break;case 50331648:i["background-color"]=`#${f(r.toString(16),"0",6)}`;break;default:l&&t.push("xterm-bg-257")}return{classList:t,textContent:n,style:i}}(e);return{innerText:e.getChars(),classList:t,style:i,textContent:n}}function m(e,t){return!(!e.isAttributeDefault()||!t.isAttributeDefault())||e.getFgColorMode()===t.getFgColorMode()&&e.getBgColorMode()===t.getBgColorMode()&&e.isBold()===t.isBold()&&e.isItalic()===t.isItalic()&&e.isDim()===t.isDim()&&e.isUnderline()===t.isUnderline()&&e.isBlink()===t.isBlink()&&e.isInvisible()===t.isInvisible()}function v(e,t,i,n){let s;e.getCell(0,t),n[n.length-1]&&m(t,i)?(s=n[n.length-1],s.innerText+=t.getChars()):(s=p(t),n.push(s));for(let o=1;o<e.length;o++)e.getCell(o-1,t),e.getCell(o,i),m(t,i)?s.innerText+=i.getChars():(s=p(i),n.push(s))}function g(e){const t=[],i=e.buffer.active.getNullCell(),n=e.buffer.active.getNullCell(),s=function(e,t){let i=e.buffer.active.length-1;for(;i>=0;){const n=e.buffer.active.getLine(i);for(let e=0;e<n.length;e++)if(n.getCell(e,t),0!==t.getCode())return i;i--}return-1}(e,n)+1;let o;for(let r=0;r<s;r++){const s=e.buffer.active.getLine(r);s.isWrapped&&void 0!==o?v(s,i,n,o):(o=[],v(s,i,n,o),t.push(o))}return t}var y=i(186),w=function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};const x=s()("plugins/bash-like/pty/client"),b=/\x1b\[\?1h/,C=/\x1b\[\?1l/,S=/\x1b\[\??(47|1047|1049)h/,E=/\x1b\[\??(47|1047|1049)l/;let z,k=0;function N(){k++}function O(e){const t=e._kui_pty_cachedSize;if(t&&t.resizeGeneration===k)return t}window&&(window.addEventListener("resize",N),a.Events.eventChannelUnsafe.on("/zoom",N));class L{constructor(e,t,i,n){this.alt=!1,this.wasAlt=!1,this.app=!1,this._frozen=!1,this.tab=t,this.execOptions=i,this.terminal=e,this.uuid=n,this.resizeNow=this.resize.bind(this,!0),window.addEventListener("resize",this.resizeNow),this.clearXtermSelectionNow=()=>{e.clearSelection()},document.addEventListener("select",this.clearXtermSelectionNow)}get ws(){return this._ws}set ws(e){this._ws=e}destroy(){this.exitAltBufferMode(),this.exitApplicationMode(),window.removeEventListener("resize",this.resizeNow),document.removeEventListener("select",this.clearXtermSelectionNow)}hideTrailingEmptyBlanks(e=!1,t=this.terminal.element,i=0){if(this.frozen)return;if(e)this.frozen=!0;else{const e=t.querySelectorAll(".xterm-rows > .xterm-hidden-row");for(let t=0;t<e.length;t++)e[t].classList.remove("xterm-hidden-row")}const n=t.querySelector(".xterm-rows").children;for(let t=n.length-1;t>=i&&0===n[t].children.length;t--)e?n[t].remove():n[t].classList.add("xterm-hidden-row")}static hideCursorOnlyRow(e){!function(e){const t=e.querySelector(".xterm-rows .xterm-cursor"),i=t&&t.parentNode;i&&1===i.children.length&&i.remove()}(e)}getSize(e){const t=O(this.tab);if(!e&&void 0!==t)return t;const i=this.terminal._core.viewport,n=i._renderService.dimensions,s=i._charSizeService.width*window.devicePixelRatio/n.scaledCharWidth,{width:o,height:r}=this.tab.getSize(),a=Math.floor(o/n.actualCellWidth/s),l=Math.floor(r/n.actualCellHeight);x("getSize",a,l,o,r);const c={rows:l,cols:a};return isNaN(l)||isNaN(a)||function(e,{rows:t,cols:i}){e._kui_pty_cachedSize={rows:t,cols:i,resizeGeneration:k}}(this.tab,c),c}set frozen(e){this._frozen=e}get frozen(){return this._frozen}resize(e=!1,t=!1){if(this.frozen)return;const{rows:i,cols:n}=this.getSize(e);if(this.terminal.rows!==i||this.terminal.cols!==n||t){x("resize",n,i,this.terminal.cols,this.terminal.rows,this.inAltBufferMode());try{isNaN(i)||isNaN(n)||(this.terminal.resize(n,i),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"resize",cols:n,rows:i,uuid:this.uuid})))}catch(e){x(e.message)}}}inApplicationMode(){return this.app}inAltBufferMode(){return this.alt}wasEverInAltBufferMode(){return this.wasAlt}enterApplicationMode(){x("switching to application mode"),this.app=!0,this.tab.addClass("xterm-application-mode")}exitApplicationMode(){x("switching from application mode"),this.app=!1,this.tab.removeClass("xterm-application-mode")}enterAltBufferMode(){if(x("switching to alt buffer mode"),this.alt=!0,this.wasAlt=!0,this.exitAlt&&clearTimeout(this.exitAlt),this.execOptions["pty/force-resize"]){const{rows:e,cols:t}=this.getSize(!1);this.ws&&this.ws.readyState===WebSocket.OPEN&&(this.ws.send(JSON.stringify({type:"resize",cols:t,rows:e+1,uuid:this.uuid})),setTimeout((()=>{this.ws.send(JSON.stringify({type:"resize",cols:t,rows:e,uuid:this.uuid})),this.tab.addClass("xterm-alt-buffer-mode")}),1))}else this.tab.addClass("xterm-alt-buffer-mode")}exitAltBufferMode(){x("switching from alt buffer mode"),this.alt=!1,this.tab.removeClass("xterm-alt-buffer-mode")}}function M(e){if(e||!z){x("computing font properties");const e=getComputedStyle(document.querySelector("body .repl .kui--scrollback")),t=(t,i="color")=>e.getPropertyValue(`--${i}-${t}`).trim(),i=parseFloat(e.fontSize.replace(/px$/,"")),n=t("monospace","font");z={fontFamily:n,fontSize:i}}return z}const A=(e,t=!1)=>{try{const{fontFamily:i,fontSize:n}=M(t);e.setOption("fontFamily",i),e.setOption("fontSize",n),x("fontSize",n),e.setOption("fontWeight",400),e.setOption("fontWeightBold",600)}catch(e){console.error("Error setting terminal font size",e)}},B=e=>w(void 0,void 0,void 0,(function*(){try{x("initializing remote channel to kui proxy");const t=yield e.REPL.rexec("bash websocket open",{rethrowErrors:!0}),{proto:n,port:s,path:o,uid:r,gid:a}=t.content,l=window.location.href.replace(/#?\/?$/,"").replace(/^http(s?):\/\/([^:/]+)(:\d+)?/,`${n}://$2${-1===s?"$3":":"+s}`).replace(/\/(index\.html)?$/,""),c=new URL(o,l).href;x("here is the kui proxy websocket url",c,n,s,o,r,a);return new(0,(yield i.e(7860).then(i.bind(i,7860))).default)(c,r,a)}catch(e){throw 503!==e.statusCode&&console.error("error opening websocket",e),e}})),T=(e,t)=>w(void 0,void 0,void 0,(function*(){const e=new u.Z;return yield e.init(t),e})),I=()=>w(void 0,void 0,void 0,(function*(){console.log("webviewChannelFactory");const e=new d.hV;return e.init(),e})),P=(e,t,i,n,s,d)=>new Promise(((n,s)=>{w(void 0,void 0,void 0,(function*(){let u,f,p,m;const v=(0,o.Z)();try{if((d.quiet||d.replSilence)&&x("Warning: non-headless PTY exec without a head"),!d.quiet&&!d.replSilence){p=document.createElement("xterm"),p.classList.add("xterm-container"),d.replSilence&&(x("repl silence"),p.style.display="none",p.classList.add("repl-temporary"));const t=O(e),{fontFamily:i,fontSize:n}=M(!1);f=new r.Terminal({rendererType:"dom",cols:t&&t.cols||80,rows:t&&t.rows||40,fontFamily:i,fontSize:n}),f.open(p);const s=()=>A(f,!0);a.Events.eventChannelUnsafe.on("/theme/change",s),u=new L(f,e,d,v),a.Events.eventChannelUnsafe.once(`/command/stdout/done/${e.uuid}/${d.execUUID}`,(()=>{u.resize()})),yield d.stdout(p),u.hideTrailingEmptyBlanks();const o=()=>{A(f,!0),u.resize()};a.Events.eventChannelUnsafe.on("/zoom",o);const l=()=>{a.Events.eventChannelUnsafe.off("/zoom",o),a.Events.eventChannelUnsafe.off("/theme/change",s)};f.element.classList.add("xterm-empty-row-heuristic"),m=()=>{l(),u.destroy(),d.type===a.ExecType.Nested&&!1!==d.quiet||u.wasEverInAltBufferMode()?d.stdout(null):p.classList.add("xterm-terminated")}}const o=t=>w(void 0,void 0,void 0,(function*(){const o={write:e=>t.send(JSON.stringify({type:"data",data:e,uuid:v})),xon:()=>{x("xon requested"),t.send(JSON.stringify({type:"xon",uuid:v}))},xoff:()=>{x("xoff requested"),t.send(JSON.stringify({type:"xoff",uuid:v}))},resize:(e,i)=>{t.send(JSON.stringify({type:"resize",rows:e,cols:i,uuid:v}))},abort:()=>{x("abort requested"),t.send(JSON.stringify({type:"kill",uuid:v}))}};yield function(e,t,i,n,s,o,r,l,c,d,u,h,f){return w(this,void 0,void 0,(function*(){let l,p=!1,m=0;const v=e=>{e._kuiAlreadyFocused||setTimeout((()=>{p||e._kuiAlreadyFocused||(e._kuiAlreadyFocused=!0,e.focus())}),100)};let y,z,k,N=!1,O="";e&&e.onData((e=>{p?n.frozen=!0:s.readyState===WebSocket.CLOSING||s.readyState===WebSocket.CLOSED?(x("queued input out back",e),O+=e):(O+=e,k&&(clearTimeout(k),k=void 0),k=setTimeout((()=>{if(O&&s.readyState===WebSocket.OPEN){const e=O;O="",s.send(JSON.stringify({type:"data",data:e,uuid:i}))}}),1))}));const L=()=>{n.inAltBufferMode()||o.scrollToBottom(c.execUUID)},M=e&&setInterval(L,400),A=()=>{const t=(0,a.disableInputQueueing)(o);t.length>0&&(x("queued input up front",t),setTimeout((()=>s.send(JSON.stringify({type:"data",data:t,uuid:i}))),50)),e&&v(e)};let B;e&&(B=t=>{t&&setTimeout((()=>e.focus()))},o.onActivate(B));let T=!0;const I=e=>w(this,void 0,void 0,(function*(){(e.end>e.start||T)&&n.hideTrailingEmptyBlanks(),T=!1}));e&&(n.hideTrailingEmptyBlanks(),l=e.onRender(I));const P=k=>w(this,void 0,void 0,(function*(){const O=JSON.parse("string"==typeof k?k:k.data);if(O.uuid===i)if("state"===O.type&&"ready"===O.state)e&&A(),c.onReady&&(yield c.onReady(f));else if("data"===O.type&&e)e._kuiAlreadyFocused||A(),b.test(O.data)?(n.enterApplicationMode(),v(e)):C.test(O.data)&&n.exitApplicationMode(),S.test(O.data)?(v(e),n.enterAltBufferMode()):E.test(O.data)&&n.exitAltBufferMode(),(c.type!==a.ExecType.Nested||!1===c.quiet||c.stdout)&&(m++,N=!0,z=/File exists/i.test(O.data)?409:/no such/i.test(O.data)||/not found/i.test(O.data)?404:z,setTimeout((()=>{e.write(O.data,(()=>{--m<=0&&y&&y()}))})));else if("data"===O.type&&c.stdout&&c.onInit)N=!0,c.stdout(O.data);else if("exit"===O.type){x("exit",O.exitCode,r),p=!0,c.onExit&&c.onExit(O.exitCode),e&&(clearInterval(M),l.dispose(),o.offActivate(B)),0!==O.exitCode&&N&&void 0!==t&&t.classList.add("error");const i=e=>w(this,void 0,void 0,(function*(){if(0!==O.exitCode){const t=new Error("");409===z?t.code=409:127!==O.exitCode&&404===z?t.code=404:t.code=O.exitCode,t.hide=!0,e?u(Object.assign(e,{code:t.code})):h(t)}else u(e||!0)}));if(!e)return s.removeEventListener("message",P),void i();const n=()=>{L(),s.removeEventListener("message",P),d(),window.requestAnimationFrame((()=>{c.stdout(null);const t={apiVersion:"kui-shell/v1",kind:"XtermResponse",rows:g(e),code:0};c.stdout(t),i(t)}))};m>0?y=n:n()}}));s.on("message",P)}))}(f,p,v,u,t,e,i,0,d,m,n,s,o),d.onInit&&(d.stdout=yield d.onInit(o))})),z=yield((e,t,i,n,s,o,r,d)=>w(void 0,void 0,void 0,(function*(){const u=a.Capabilities.inBrowser()?void 0!==window["webview-proxy"]?I:B:T,f=Object.assign({},y.env,s.env||{}),p=i=>w(void 0,void 0,void 0,(function*(){i.removeEventListener("open",p),yield r(i);const a={type:"exec",cmdline:e,uuid:t,rows:o?o.rows:80,cols:o?o.cols:40,cwd:yield(0,h.Z)(s,n),env:Object.keys(f).length>0&&f};x("exec after open",a),i.send(JSON.stringify(a))})),m=(0,c.getChannelForTab)(i);if(m)return p(yield m),o&&d(o),m;{x("initializing pty channel");const e=yield(0,l.oY)(i,u(i,t));if(e.on("open",(()=>p(e))),a.Capabilities.inBrowser()){const n=function(s){x("channel has closed",s.target,t),e.removeEventListener("close",n),i.state.closed||(x("attempting to reestablish connection, because the tab is still open"),(0,c.invalidateSession)(i))};e.on("close",n)}return e}})))(i,v,e,t,d,f,o,focus).catch((e=>{throw 503!==e.code&&console.error("error creating channel",e),m&&m(),e}));u&&(u.ws=z)}catch(e){const t=e;127===t.code||404===t.code?(t.code=127,s(t)):(503!==t.code&&x("error in pty/client",t),t.message||(t.message="Internal Error"),s(t))}}))}))},62549:(e,t,i)=>{i.d(t,{Z:()=>c,O:()=>d});var n=i(17187),s=i(96690),o=i(29224),r=function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};function a(e){return`/plugin-bash-like/pty/message/${e}`}class l extends n.EventEmitter{constructor(){super(...arguments),this.isAlive=!0,this.readyState=s.kQ.OPEN,this.handleMessage=(e,t)=>{this.emit("message",t)}}init(e,t){return r(this,void 0,void 0,(function*(){const{ipcMain:n}=yield Promise.resolve().then(i.t.bind(i,7676,23));this.ipcMain=n,this.otherSide=t,this.messageChannel=a(e.execUUID),n.on(this.messageChannel,this.handleMessage),yield(0,o.disableBashSessions)(),yield(0,o.onConnection)((()=>{try{this.ipcMain.off(this.messageChannel,this.handleMessage)}catch(e){console.error("Error turning off PTY events",e)}}))(this)}))}close(){}send(e){try{this.otherSide.isDestroyed()||this.otherSide.send(this.messageChannel,e)}catch(e){console.error("Error sending PTY output to renderer",e)}}removeEventListener(e,t){this.off(e,t)}}class c extends n.EventEmitter{constructor(){super(...arguments),this.isAlive=!0,this.readyState=s.kQ.OPEN,this.handleMessage=(e,t)=>{this.emit("message",t)}}init(e){return r(this,void 0,void 0,(function*(){const{ipcRenderer:t}=yield Promise.resolve().then(i.t.bind(i,7676,23));this.ipcRenderer=t,this.messageChannel=a(e),window.addEventListener("beforeunload",(()=>{this.send(JSON.stringify({type:"kill",uuid:e})),this.ipcRenderer.off(this.messageChannel,this.handleMessage)})),t.once(`/exec/response/${e}`,((e,t)=>{!0===JSON.parse(t).returnValue&&(this.ipcRenderer.on(this.messageChannel,this.handleMessage),this.emit("open"))})),t.send("/exec/invoke",JSON.stringify({module:"plugin-bash-like",main:"initMainPty",hash:e,args:{execUUID:e}}))}))}close(){}send(e){try{this.ipcRenderer.send(this.messageChannel,e.toString())}catch(e){console.error("Error sending PTY message to main process",e)}}removeEventListener(e,t){this.off(e,t)}}function d(e,t){return r(this,void 0,void 0,(function*(){try{return yield(new l).init(e,t),!0}catch(e){return console.error("Error starting up pty",e),!1}}))}},3129:(e,t,i)=>{i.r(t),i.d(t,{getChannelForTab:()=>u,init:()=>m,invalidateSession:()=>p,pollUntilOnline:()=>h});var n=i(11227),s=i.n(n),o=i(18495);const r=s()("plugins/bash-like/pty/ui");var a=i(84932),l=function(e,t,i,n){return new(i||(i=Promise))((function(s,o){function r(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};const c=(0,o.i18n)("plugin-bash-like"),d=s()("plugins/bash-like/pty/session");function u(e){if((0,a.Lu)())throw new Error("Exiting");if(o.Capabilities.inBrowser())return(0,a.E6)(e)}function h(e){return new Promise((t=>{let i=!1;const n=setTimeout((()=>{i||(r("setOffline"),o.Events.eventChannelUnsafe.emit("/proxy/offline"))}),5e3),s=(l=0)=>(d("trying to establish session",e),e.REPL.qexec("echo initializing session",void 0,void 0,{tab:e}).then((()=>{i=!0,clearTimeout(n),r("setOnline"),o.Events.eventChannelUnsafe.emit("/proxy/online"),t()})).catch((t=>{const i=t;return 503!==i.code&&(console.error("error establishing session",i.code,i.statusCode,i),(0,a.e5)(e)),setTimeout((()=>s(l+1)),l<10?2e3:l<100?4e3:1e4),c("Could not establish a new session")})));s()}))}function f(e){return l(this,void 0,void 0,(function*(){const t=(0,a.E6)(e)||new Promise(((t,i)=>l(this,void 0,void 0,(function*(){try{yield h(e),e.classList.add("kui--session-init-done"),t(yield u(e))}catch(e){i(e)}}))));yield t,e.classList.add("kui--session-init-done")}))}function p(e){(0,a.e5)(e),o.Events.eventBus.emit("/tab/offline",e),o.Events.eventBus.emitWithTabId("/tab/offline",e.state.uuid)}function m(e){return l(this,void 0,void 0,(function*(){const{proxyServer:t}=yield i.e(1668).then(i.t.bind(i,17186,19)).catch((()=>(console.log("using default proxy configuration"),{proxyServer:{enabled:!1}})));o.Capabilities.inBrowser()&&!1!==t.enabled&&(d("initializing pty sessions"),e.registerSessionInitializer(f))}))}},84932:(e,t,i)=>{i.d(t,{Lu:()=>o,e5:()=>r,E6:()=>a,oY:()=>l});let n,s=!1;function o(){return s}function r(e){n=void 0}function a(e){return n}function l(e,t){return n=t,t.then((e=>{window.addEventListener("beforeunload",(()=>{s=!0,e.close()}))})),n}}}]);