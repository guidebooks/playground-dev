(self.webpackChunkKuiClientTemplate=self.webpackChunkKuiClientTemplate||[]).push([[9194],{79194:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>f});var s=i(67294),n=i(72045),o=i(12617),r=i(12320),a=i(18495),h=i(60898),l=i(50816),d=i(58853),c=i(25218);const m=(0,a.i18n)("plugin-kubectl");class u extends s.PureComponent{toolbarButtonsForError(t){return"Stopped"===t||"Error"===t?[{mode:"retry-streaming",label:m("Retry"),kind:"view",icon:s.createElement(h.PJ,{icon:"Retry",onClick:()=>this.showContainer(this.state.container)}),command:()=>{}}]:[]}toolbarButtonsForStreaming(t){return[]}toolbarButtons(t){return this.toolbarButtonsForError(t).concat(this.toolbarButtonsForStreaming(t),this.containerList())}supportsAllContainers(){return!1}componentWillUnmount(){this.state.job&&this.state.job.abort()}updateToolbar(t){this.props.toolbarController.willUpdateToolbar(this.toolbarText(t),this.toolbarButtons(t),!0)}showContainer(t){this.setState({container:t})}get containers(){if(this.props.resource){const{containers:t=[]}=(0,c.th)(this.props.resource)?this.props.resource.spec:this.props.resource.spec.template.spec;return t}return[]}containerOptions(){const t=this.containers,e=t.map((t=>({label:t.name,isSelected:this.state.container===t.name,hasDivider:!1,handler:()=>this.showContainer(t.name)}))).concat(this.supportsAllContainers()&&1!==t.length?[{label:m("All Containers"),isSelected:this.isAllContainers(),hasDivider:!0,handler:()=>this.showContainer(void 0)}]:[]);return s.createElement(h.vb,{isPlain:!0,actions:e})}isAllContainers(){return!this.state.container}containerList(){return[{mode:"container-list",label:"Select a container",kind:"view",command:()=>{},icon:this.containerOptions()}]}}var p=i(186);const g=(0,a.i18n)("plugin-kubectl","exec");function b(t,e){if(/^#[0-9a-fA-F]{6}$/.test(t)){return`rgba(${parseInt(t.slice(1,3),16)},${parseInt(t.slice(3,5),16)},${parseInt(t.slice(5,7),16)},${e})`}return t}class f extends u{constructor(t){super(t),this.cleaners=[],this.isIdle=!0,this._unmounted=!1,this._initInProgressForContainer=!1,this._initCount=0,this.state={container:this.defaultContainer(),dom:void 0,xterm:void 0,doResize:void 0,perTerminalCleaners:[],isLive:"Paused",isTerminated:!1,waitingForHysteresis:!1,gotSomeData:!1,job:void 0,streamUUID:void 0},this.updateToolbar(this.state.isLive);const{uuid:e}=this.props.tab,i=()=>{this.doFocus(),this.doXon()},s=`/mode/focus/on/tab/${e}/mode/${this.mode()}`;a.Events.eventChannelUnsafe.on(s,i),this.cleaners.push((()=>a.Events.eventChannelUnsafe.off(s,i)));const n=this.doXoff.bind(this),o=`/mode/focus/off/tab/${e}/mode/${this.mode()}`;a.Events.eventChannelUnsafe.on(o,n),this.cleaners.push((()=>a.Events.eventChannelUnsafe.off(o,n)));const r=this.onWindowResize.bind(this);window.addEventListener("resize",r),this.cleaners.push((()=>window.removeEventListener("resize",r)));const h=this.onTabLayoutChange.bind(this);a.Events.eventBus.onTabLayoutChange(e,h),this.cleaners.push((()=>a.Events.eventBus.offTabLayoutChange(e,h)))}defaultContainer(){if(this.props.args.argsForMode){const t=(0,d.ZO)(this.props.args.argsForMode,"exec");if(t)return t}return this.props.resource.spec.containers[0].name}mode(){return this.props.mode}doXon(){this.state&&this.state.job&&setTimeout((()=>this.state.job.xon()))}doXoff(){this.state&&this.state.job&&setTimeout((()=>this.state.job.xoff()))}doFocus(){this.state&&this.state.xterm&&setTimeout((()=>{this.state.xterm.focus()}))}static injectTheme(t,e){const i=getComputedStyle(e),s=(t,e="color")=>i.getPropertyValue(`--${e}-${t}`).trim(),n={foreground:s("text-01"),background:s("sidecar-background-01"),cursor:s("support-01"),selection:b(s("selection-background"),.3),black:s("black"),red:s("red"),green:s("green"),yellow:s("yellow"),blue:s("blue"),magenta:s("magenta"),cyan:s("cyan"),white:s("white"),brightBlack:s("black"),brightRed:s("red"),brightGreen:s("green"),brightYellow:s("yellow"),brightBlue:s("blue"),brightMagenta:s("magenta"),brightCyan:s("cyan"),brightWhite:s("white")};t.setOption("theme",n),t.setOption("fontFamily",s("monospace","font"));try{const e=getComputedStyle(document.querySelector("body .repl .repl-input input"));t.setOption("fontSize",parseInt(e.fontSize.replace(/px$/,""),10)),t.setOption("fontWeight",400),t.setOption("fontWeightBold",600)}catch(t){console.error("Error setting terminal font size",t)}}onWindowResize(){this.state.xterm&&this.state.doResize()}onTabLayoutChange(t){this.state.xterm&&!t.isSidecarNowHidden&&this.state.doResize()}componentWillUnmount(){this._unmounted=!0,super.componentWillUnmount(),this.disposeTerminal(),this.cleaners.forEach((t=>t()))}disposeTerminal(){this.state.xterm.dispose(),this.state.perTerminalCleaners.forEach((t=>t())),this.setState({xterm:void 0,perTerminalCleaners:[]})}componentDidUpdate(){this.updateToolbar(this.state.isLive),this.state.job||this.state.isTerminated||this.initStream()}abortPriorJob(){if(this.state.job){const t=this.state.job;setTimeout((()=>t.abort()),5e3)}}showContainer(t,e){this.setState((i=>(this.abortPriorJob(),Object.assign({container:t,job:void 0,streamUUID:void 0,isTerminated:!1},e?e(i):{}))))}static getDerivedStateFromProps(t,e){return e.dom&&!e.xterm?f.initTerminal(e.dom):e}toolbarText(t){return this.state.isTerminated?{type:"error",text:g("The terminal connection has closed.")}:this.state.job?"Idle"===this.state.isLive?{type:"warning",text:g("Connection is idle, and will expire shortly. Connected to container X.",this.state.container)}:{type:"info",text:g("Connected to container X.",this.state.container)}:{type:"warning",text:g("Please wait. Connecting to container X.",this.state.container)}}ptyCommand(){const{args:t,resource:e}=this.props,{container:i}=this.state,s=t.argsForMode&&(0,d.QG)(t.argsForMode,t.argsForMode.command)||(0,d.QG)(this.props.args,`${(0,l.fY)(this.props.args)} exec -it ${e.metadata.name} -c ${i} -n ${e.metadata.namespace} -- sh`);return t.argsForMode&&t.argsForMode.command&&(t.argsForMode.command=void 0),{command:s}}write(t){this.state.xterm&&this.state.xterm.write(t)}gotSomeData(t){this.state.gotSomeData||this.setState((e=>{if(!e.gotSomeData&&e.streamUUID===t)return{gotSomeData:!0}}))}indicate(t){this.updateToolbar(t),this.setState({isLive:t})}initiateIdleCountdown(){this.indicate("Idle"),this.idleTimeout=setTimeout((()=>{this.abortPriorJob()}),3e5)}initiateIdleTimer(){return setTimeout((()=>this.initiateIdleCountdown()),9e5)}initStream(){const{tab:{REPL:t}}=this.props,{xterm:e}=this.state,i=(0,n.Z)();if(this._initInProgressForContainer===this.state.container)return;this._initCount++>0&&e.reset(),this._initInProgressForContainer=this.state.container;const{command:s,isLive:o="Live"}=this.ptyCommand();t.qexec(s,void 0,void 0,{tab:this.props.tab,onInit:()=>{if(!this._unmounted)return this._initInProgressForContainer=!1,t=>{this.idleTimeout&&(clearTimeout(this.idleTimeout),this.indicate(o),this.idleTimeout=this.initiateIdleTimer()),"string"==typeof t&&this.state.streamUUID===i&&(this.gotSomeData(i),this.write(t))}},onReady:t=>{if(!this._unmounted){if((0,a.isResizable)(t)){e.onResize((({rows:e,cols:i})=>{t.resize(e,i)}));const{doResize:i}=this.state;if(i){this.state.doResize();const t=new ResizeObserver((function(t){t.every((t=>t.contentRect.width>0&&t.contentRect.height>0))&&setTimeout(i)}));t.observe(this.state.dom),this.state.perTerminalCleaners.push((()=>t.disconnect()))}}e.onData((e=>{this._unmounted||this.state.streamUUID!==i||t.write(e)})),this.doFocus(),setTimeout((()=>{this.state.isTerminated||this.setState((t=>{if(t.streamUUID===i)return{waitingForHysteresis:!1}}))}),1500),this.idleTimeout&&clearTimeout(this.idleTimeout),this.idleTimeout=this.initiateIdleTimer(),this.setState({job:t,streamUUID:i,isLive:o,waitingForHysteresis:!0})}},onExit:t=>{this._unmounted||this.setState((e=>{if(e.streamUUID===i){const i=0===t?"Stopped":"Error";return this.updateToolbar(i),{job:void 0,streamUUID:void 0,container:e.container,isLive:i,isTerminated:!0}}}))}}).catch((t=>{this._unmounted||this.state.streamUUID!==i||(console.error(t),this.updateToolbar("Error"))}))}isAllContainers(){return super.isAllContainers()&&!this.state.isTerminated}static initTerminal(t){const e=(0,h.w6)()||p.env.RUNNING_SHELL_TEST||p.env.RUNNING_KUI_TEST?"dom":"canvas",i=new r.Terminal({scrollback:1e3,rendererType:e}),s=[],n=()=>f.injectTheme(i,t);n(),a.Events.eventChannelUnsafe.on("/theme/change",n),s.push((()=>a.Events.eventChannelUnsafe.on("/theme/change",n)));const l=new o.FitAddon;i.loadAddon(l),i.open(t);return{xterm:i,doResize:()=>{try{l.fit()}catch(t){console.error(t)}},perTerminalCleaners:s}}needsHysteresis(){return!1}nothingToShow(){return s.createElement(s.Fragment,null)}maybeNothingToShow(){if(this.needsHysteresis()){if(this.state.waitingForHysteresis||!this.state.xterm||!this.state.job)return s.createElement(s.Fragment,null);if(!this.state.gotSomeData)return this.nothingToShow()}}notReady(){return this.state.dom&&!this.state.xterm}render(){return this.notReady()?s.createElement(h.gb,null):s.createElement("div",{className:"kui--full-height kui--terminal kui--relative-positioning","data-needs-hysteresis":this.needsHysteresis(),"data-got-some-data":this.state.gotSomeData,ref:t=>this.setState({dom:t})},this.maybeNothingToShow())}}},12617:t=>{self,t.exports=(()=>{"use strict";var t={775:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.FitAddon=void 0;var i=function(){function t(){}return t.prototype.activate=function(t){this._terminal=t},t.prototype.dispose=function(){},t.prototype.fit=function(){var t=this.proposeDimensions();if(t&&this._terminal){var e=this._terminal._core;this._terminal.rows===t.rows&&this._terminal.cols===t.cols||(e._renderService.clear(),this._terminal.resize(t.cols,t.rows))}},t.prototype.proposeDimensions=function(){if(this._terminal&&this._terminal.element&&this._terminal.element.parentElement){var t=this._terminal._core;if(0!==t._renderService.dimensions.actualCellWidth&&0!==t._renderService.dimensions.actualCellHeight){var e=window.getComputedStyle(this._terminal.element.parentElement),i=parseInt(e.getPropertyValue("height")),s=Math.max(0,parseInt(e.getPropertyValue("width"))),n=window.getComputedStyle(this._terminal.element),o=i-(parseInt(n.getPropertyValue("padding-top"))+parseInt(n.getPropertyValue("padding-bottom"))),r=s-(parseInt(n.getPropertyValue("padding-right"))+parseInt(n.getPropertyValue("padding-left")))-t.viewport.scrollBarWidth;return{cols:Math.max(2,Math.floor(r/t._renderService.dimensions.actualCellWidth)),rows:Math.max(1,Math.floor(o/t._renderService.dimensions.actualCellHeight))}}}},t}();e.FitAddon=i}},e={};return function i(s){if(e[s])return e[s].exports;var n=e[s]={exports:{}};return t[s](n,n.exports,i),n.exports}(775)})()}}]);